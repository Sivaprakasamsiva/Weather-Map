<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌤</text></svg>">
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --secondary: #f59e0b;
            --dark: #0b1220;
            --light: #f8fafc;
            --panel-bg: rgba(15, 23, 42, 0.85);
            --panel-text: #e2e8f0;
            --radius: 16px;
            --shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: var(--light);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            padding-bottom: 60px; /* Space for footer */
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            min-height: calc(100vh - 60px); /* Adjust for footer */
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
        }

        /* Header & Search */
        .header {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            animation: fadeIn 0.8s ease-out;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            font-weight: 700;
            color: var(--light);
        }

        .logo-icon {
            font-size: 32px;
            animation: pulse 2s infinite;
        }

        .search-container {
            width: 100%;
            max-width: 700px;
            position: relative;
        }

        .search-box {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .search-box:focus-within {
            box-shadow: 0 0 0 2px var(--primary);
            transform: translateY(-2px);
        }

        .search-box input {
            flex: 1;
            padding: 16px 20px;
            font-size: 18px;
            border: none;
            outline: none;
            background: transparent;
            color: var(--light);
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-box button {
            width: 60px;
            display: grid;
            place-items: center;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .search-box button:hover {
            background: var(--primary-dark);
        }

        /* Suggestions */
        #suggestions {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            list-style: none;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-height: 300px;
            overflow: auto;
            display: none;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideDown 0.3s ease-out;
        }

        #suggestions li {
            padding: 14px 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #suggestions li:hover, #suggestions li.active {
            background: rgba(14, 165, 233, 0.15);
        }

        .suggestion-icon {
            font-size: 20px;
        }

        /* Map */
        .map-container {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            height: 100%;
            min-height: 400px;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Weather Panel */
        .weather-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.5s ease-out;
        }

        .current-weather {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .city-name {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .local-time {
            font-size: 16px;
            opacity: 0.8;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weather-condition {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .weather-icon {
            font-size: 32px;
            animation: bounce 2s infinite;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .detail-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .detail-value {
            font-size: 24px;
            font-weight: 700;
        }

        .detail-label {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Forecast */
        .forecast {
            margin-top: 20px;
        }

        .forecast-title {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .forecast-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .forecast-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            transition: var(--transition);
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .forecast-day {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .forecast-temp {
            font-size: 20px;
            font-weight: 700;
            margin: 8px 0;
        }

        /* Facts Panel */
        .facts-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.7s ease-out;
            grid-column: 1 / -1;
            width: 100%;
            margin-top: 0;
        }

        .facts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .facts-content {
            line-height: 1.6;
        }

        /* Improved Load Information Button */
        #moreBtn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #moreBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }

        #moreBtn:active {
            transform: translateY(0);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Weather animations */
        .weather-animation {
            height: 120px;
            width: 100%;
            position: relative;
            margin: 20px 0;
            overflow: hidden;
            border-radius: var(--radius);
        }

        .sun {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #fff59e, #fbbf24 60%, #f59e0b);
            border-radius: 50%;
            box-shadow: 0 0 40px 15px rgba(251, 191, 36, 0.4);
            transform: translate(-50%, -50%);
            animation: pulse 3s infinite;
        }

        .moon {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: #e5e7eb;
            border-radius: 50%;
            box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
        }

        .moon-phase {
            position: absolute;
            background: #1e293b;
            border-radius: 50%;
            transition: all 1s ease;
        }

        .cloud {
            position: absolute;
            background: #fff;
            width: 70px;
            height: 30px;
            border-radius: 20px;
            top: 40px;
            left: 30px;
            filter: drop-shadow(0 5px 8px rgba(0, 0, 0, 0.2));
            animation: drift 12s linear infinite;
        }

        .cloud::before, .cloud::after {
            content: "";
            position: absolute;
            background: #fff;
            border-radius: 50%;
        }

        .cloud::before {
            width: 34px;
            height: 34px;
            top: -16px;
            left: 12px;
        }

        .cloud::after {
            width: 26px;
            height: 26px;
            top: -10px;
            left: 36px;
        }

        .rain-drop {
            position: absolute;
            width: 3px;
            height: 15px;
            background: #60a5fa;
            top: 70px;
            left: 45px;
            opacity: 0.8;
            border-radius: 2px;
            animation: fall 1s linear infinite;
        }

        .rain-drop:nth-child(2) { left: 65px; animation-delay: 0.2s; }
        .rain-drop:nth-child(3) { left: 85px; animation-delay: 0.4s; }
        .rain-drop:nth-child(4) { left: 105px; animation-delay: 0.6s; }

        .snowflake {
            position: absolute;
            background: white;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            top: 40px;
            animation: snowfall 8s linear infinite;
            opacity: 0.8;
        }

        .snowflake:nth-child(1) { left: 30px; animation-delay: 0s; }
        .snowflake:nth-child(2) { left: 60px; animation-delay: 1s; }
        .snowflake:nth-child(3) { left: 90px; animation-delay: 2s; }
        .snowflake:nth-child(4) { left: 120px; animation-delay: 3s; }

        .lightning {
            position: absolute;
            width: 4px;
            height: 25px;
            background: #fde047;
            top: 40px;
            left: 80px;
            animation: flash 2s infinite;
            box-shadow: 0 0 15px 5px rgba(253, 224, 71, 0.5);
        }

        @keyframes drift {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(400px); }
        }

        @keyframes fall {
            0% { transform: translateY(0); opacity: 0.9; }
            100% { transform: translateY(50px); opacity: 0; }
        }

        @keyframes snowfall {
            0% { transform: translateY(0) rotate(0deg); opacity: 0.8; }
            100% { transform: translateY(80px) rotate(360deg); opacity: 0; }
        }

        @keyframes flash {
            0%, 30%, 100% { opacity: 0; }
            5%, 15% { opacity: 1; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
                gap: 15px;
            }
            
            .logo {
                font-size: 24px;
            }
            
            .search-box input {
                padding: 14px;
                font-size: 16px;
            }
            
            .weather-details {
                grid-template-columns: 1fr 1fr;
            }
            
            .forecast-cards {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }

        /* Transparent console */
        .debug-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 200px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            color: #00ff00;
            overflow: auto;
            z-index: 1000;
            display: none;
            border: 1px solid rgba(0, 255, 0, 0.2);
        }

        /* Toggle button for console */
        .console-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            display: grid;
            place-items: center;
            box-shadow: var(--shadow);
        }

        /* Footer */
        footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            text-align: center;
            padding: 15px;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            font-size: 14px;
            color: var(--panel-text);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
        }

        footer a:hover {
            color: var(--secondary);
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <span class="logo-icon">🌤</span>
                <span>Weather Map</span>
            </div>
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="cityInput" placeholder="Search for a city...">
                    <button id="searchBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                </div>
                <ul id="suggestions"></ul>
            </div>
        </header>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="weather-panel">
            <div class="current-weather">
                <h2 class="city-name"><span id="cityName">—</span> <span id="countryFlag"></span></h2>
                <div class="local-time">
                    <span id="timeIcon">🕒</span>
                    <span id="localTime">—</span>
                </div>
                <div class="weather-condition">
                    <span class="weather-icon" id="weatherIcon">🌤</span>
                    <span id="conditionText">—</span>
                </div>
                
                <div class="weather-animation" id="weatherAnimation">
                    <!-- Animation will be inserted here -->
                </div>
                
                <div class="weather-details">
                    <div class="detail-card">
                        <div class="detail-value" id="temp">—</div>
                        <div class="detail-label">Temperature</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-value" id="humidity">—</div>
                        <div class="detail-label">Humidity</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-value" id="wind">—</div>
                        <div class="detail-label">Wind Speed</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-value" id="feelsLike">—</div>
                        <div class="detail-label">Feels Like</div>
                    </div>
                </div>
            </div>
            
            <div class="forecast">
                <h3 class="forecast-title"><span>📅</span> 5-Day Forecast</h3>
                <div class="forecast-cards" id="forecast">
                    <!-- Forecast will be inserted here -->
                </div>
            </div>
        </div>

        <div class="facts-panel">
            <div class="facts-header">
                <h3>📍 City Facts</h3>
                <button id="moreBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    Load Information
                </button>
            </div>
            <div class="facts-content" id="cityFacts">
                Click the button to load interesting facts about this city.
            </div>
        </div>
    </div>

    <footer>
        Made by Sivaprakasam | <a href="https://github.com/Sivaprakasamsiva/Weather-Map.git" target="_blank">Weather Map GitHub</a>
    </footer>

    <button class="console-toggle" id="consoleToggle">📟</button>
    <div class="debug-console" id="debugConsole"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Configuration
        const WEATHER_API_KEY = "Enter Your Open Wether API";
        const debugConsole = document.getElementById('debugConsole');
        const consoleToggle = document.getElementById('consoleToggle');
        
        // Debug logging
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugConsole.innerHTML += `[${timestamp}] ${message}<br>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }
        
        // Toggle console
        consoleToggle.addEventListener('click', () => {
            debugConsole.style.display = debugConsole.style.display === 'none' ? 'block' : 'none';
        });
        
        // Initialize the map
        const map = L.map('map', {
            worldCopyJump: true,
            zoomControl: false
        }).setView([20, 0], 2);

        // Add OpenStreetMap tiles with a stylish dark theme
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '©OpenStreetMap, ©CartoDB'
        }).addTo(map);

        // Add zoom control with a different position
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        let cityLayer = null;
        let animMarker = null;
        let localTimeInterval = null;

        // UI Elements
        const cityInput = document.getElementById('cityInput');
        const suggestionsEl = document.getElementById('suggestions');
        const searchBtn = document.getElementById('searchBtn');

        const nameEl = document.getElementById('cityName');
        const countryFlagEl = document.getElementById('countryFlag');
        const localTimeEl = document.getElementById('localTime');
        const timeIconEl = document.getElementById('timeIcon');
        const condEl = document.getElementById('conditionText');
        const weatherIconEl = document.getElementById('weatherIcon');
        const tempEl = document.getElementById('temp');
        const humEl = document.getElementById('humidity');
        const windEl = document.getElementById('wind');
        const feelsLikeEl = document.getElementById('feelsLike');
        const forecastEl = document.getElementById('forecast');
        const moreBtn = document.getElementById('moreBtn');
        const factsEl = document.getElementById('cityFacts');
        const weatherAnimationEl = document.getElementById('weatherAnimation');

        // Search functionality
        let debounceTimer;
        function debounce(fn, delay = 300) {
            return (...args) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fn(...args), delay);
            };
        }

        async function fetchSuggestions(q) {
            if (!q) {
                suggestionsEl.style.display = 'none';
                return;
            }
            
            try {
                debugLog(`Fetching suggestions for: ${q}`);
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&addressdetails=1&limit=8&polygon_geojson=1`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                
                if (!res.ok) throw new Error(`Nominatim error ${res.status}`);
                
                const data = await res.json();
                suggestionsEl.innerHTML = "";
                
                if (data.length === 0) {
                    suggestionsEl.style.display = 'none';
                    return;
                }
                
                data.forEach((place, idx) => {
                    const li = document.createElement('li');
                    
                    // Use appropriate icon based on place type
                    let icon = '📍';
                    if (place.type === 'city' || place.type === 'town') icon = '🏙️';
                    else if (place.type === 'village') icon = '🏡';
                    else if (place.class === 'boundary') icon = '🗺️';
                    
                    li.innerHTML = `<span class="suggestion-icon">${icon}</span> ${place.display_name}`;
                    li.setAttribute('role', 'option');
                    li.dataset.place = JSON.stringify(place);
                    
                    if (idx === 0) li.classList.add('active');
                    
                    li.addEventListener('click', () => {
                        selectPlace(place);
                        suggestionsEl.style.display = 'none';
                    });
                    
                    suggestionsEl.appendChild(li);
                });
                
                suggestionsEl.style.display = 'block';
                debugLog(`Found ${data.length} suggestions`);
            } catch (err) {
                console.error(err);
                debugLog('Autocomplete failed: ' + err.message);
            }
        }

        // Input event with debounce
        cityInput.addEventListener('input', debounce(e => {
            fetchSuggestions(cityInput.value.trim());
        }, 280));

        // Keyboard navigation for suggestions
        cityInput.addEventListener('keydown', (e) => {
            const items = Array.from(suggestionsEl.querySelectorAll('li'));
            if (!items.length) return;

            const idx = items.findIndex(li => li.classList.contains('active'));

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const next = (idx + 1) % items.length;
                items.forEach(li => li.classList.remove('active'));
                items[next].classList.add('active');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prev = (idx - 1 + items.length) % items.length;
                items.forEach(li => li.classList.remove('active'));
                items[prev].classList.add('active');
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const target = items[idx >= 0 ? idx : 0];
                if (target) {
                    const place = JSON.parse(target.dataset.place);
                    selectPlace(place);
                    suggestionsEl.style.display = 'none';
                }
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                suggestionsEl.style.display = 'none';
            }
        });

        // Search button handler
        searchBtn.addEventListener('click', searchFromInput);
        cityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && suggestionsEl.style.display === 'none') {
                e.preventDefault();
                searchFromInput();
            }
        });

        // Search function
        async function searchFromInput() {
            const q = cityInput.value.trim();
            if (!q) return;
            
            debugLog(`Searching for: ${q}`);
            
            try {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&addressdetails=1&limit=1&polygon_geojson=1`;
                const res = await fetch(url);
                
                if (!res.ok) throw new Error(`Nominatim error ${res.status}`);
                
                const data = await res.json();
                if (!data.length) {
                    debugLog('No results found');
                    return;
                }
                
                selectPlace(data[0]);
            } catch (err) {
                console.error(err);
                debugLog('Search failed: ' + err.message);
            }
        }

        // Select place and update map
        async function selectPlace(place) {
            debugLog(`Place selected: ${place.display_name}`);
            clearCityLayers();
            clearLocalTimeInterval();

            const lat = parseFloat(place.lat);
            const lon = parseFloat(place.lon);

            // Draw outline if polygon data is available
            if (place.geojson) {
                cityLayer = L.geoJSON(place.geojson, {
                    style: {
                        color: '#888',
                        weight: 2,
                        fillColor: '#ddd',
                        fillOpacity: 0.6
                    }
                }).addTo(map);
                
                try {
                    map.fitBounds(cityLayer.getBounds(), { padding: [30, 30] });
                } catch {
                    map.setView([lat, lon], 10);
                }
            } else {
                map.setView([lat, lon], 10);
            }

            // Update weather information
            await updateWeather(lat, lon, place.display_name, place.address?.country_code);
        }

        // Classify weather conditions
        function classifyWeather(main, description) {
            const m = (main || "").toLowerCase();
            const d = (description || "").toLowerCase();

            let outline = '#9ca3af', fill = '#e5e7eb', anim = 'clouds', label = main || 'N/A';
            let icon = '🌤';

            if (m.includes('thunder')) {
                outline = '#7c3aed';
                fill = '#e9d5ff';
                anim = 'storm';
                label = 'Thunderstorm';
                icon = '⛈';
            } else if (m.includes('rain') || m.includes('drizzle')) {
                outline = '#2563eb';
                fill = '#bfdbfe';
                anim = 'rain';
                label = 'Rain';
                icon = '🌧';
            } else if (m.includes('snow')) {
                outline = '#60a5fa';
                fill = '#dbeafe';
                anim = 'snow';
                label = 'Snow';
                icon = '❄';
            } else if (m.includes('cloud')) {
                outline = '#ffffff';
                fill = '#e5e7eb';
                anim = 'clouds';
                label = 'Clouds';
                icon = '☁';
            } else if (m.includes('clear')) {
                outline = '#f59e0b';
                fill = '#fde68a';
                anim = 'sun';
                label = 'Clear';
                icon = '☀';
            } else if (m.includes('mist') || m.includes('fog') || m.includes('haze')) {
                outline = '#6b7280';
                fill = '#d1d5db';
                anim = 'wind';
                label = 'Mist/Fog';
                icon = '🌫';
            } else if (m.includes('dust') || m.includes('smoke') || m.includes('ash')) {
                outline = '#92400e';
                fill = '#f5deb3';
                anim = 'wind';
                label = 'Dust/Smoke';
                icon = '💨';
            } else if (m.includes('squall') || m.includes('tornado')) {
                outline = '#dc2626';
                fill = '#fecaca';
                anim = 'wind';
                label = 'Severe Wind';
                icon = '💨';
            }

            return { outline, fill, anim, label, icon };
        }

        // Update weather information
        async function updateWeather(lat, lon, displayName, countryCode) {
            if (!WEATHER_API_KEY) {
                debugLog('OpenWeatherMap API key is missing');
                return;
            }

            debugLog(`Fetching weather for: ${displayName}`);
            
            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric`;
                const res = await fetch(url);
                
                if (!res.ok) throw new Error(`OpenWeather error ${res.status}`);
                
                const data = await res.json();
                debugLog('Weather data received');

                const main = data.weather?.[0]?.main || '';
                const desc = data.weather?.[0]?.description || '';
                const { outline, fill, anim, label, icon } = classifyWeather(main, desc);

                // Style outline
                if (cityLayer) {
                    cityLayer.setStyle({ color: outline, fillColor: fill, fillOpacity: 0.6, weight: 3 });
                }

                // Update panel with animation
                nameEl.textContent = displayName;
                
                // Add country flag if available
                if (countryCode) {
                    countryFlagEl.textContent = getFlagEmoji(countryCode.toUpperCase());
                }
                
                // Update local time display
                updateLocalTime(data.timezone);
                
                condEl.textContent = `${label}${desc && label.toLowerCase() !== desc.toLowerCase() ? ` (${desc})` : ''}`;
                
                // Determine if it's day or night and update icon accordingly
                const isDayTime = isDay(data.sys.sunrise, data.sys.sunset);
                let weatherIcon = icon;
                
                if (main.includes('clear')) {
                    weatherIcon = isDayTime ? '☀️' : getMoonPhaseEmoji();
                }
                
                weatherIconEl.textContent = weatherIcon;
                tempEl.textContent = `${Math.round(data.main?.temp ?? 0)}°C`;
                humEl.textContent = `${Math.round(data.main?.humidity ?? 0)}%`;
                windEl.textContent = `${Math.round(data.wind?.speed ?? 0)} m/s`;
                feelsLikeEl.textContent = `${Math.round(data.main?.feels_like ?? 0)}°C`;

                // Add weather animation
                addWeatherAnimation(isDayTime ? anim : 'night');

                // Animation marker at center of city bounds (or lat/lon)
                const center = cityLayer ? cityLayer.getBounds().getCenter() : L.latLng(lat, lon);
                addMapAnimation(center, isDayTime ? anim : 'night');

                // More facts
                moreBtn.onclick = () => fetchFacts(displayName.split(',')[0] || displayName);
                
                // Fetch forecast
                await updateForecast(lat, lon);
            } catch (err) {
                console.error(err);
                debugLog('Weather fetch failed: ' + err.message);
            }
        }

        // Check if it's currently daytime
        function isDay(sunrise, sunset) {
            const now = Math.floor(Date.now() / 1000);
            return now > sunrise && now < sunset;
        }

        // Get moon phase emoji based on current date
        function getMoonPhaseEmoji() {
            // Calculate approximate moon phase based on current date
            const knownNewMoon = new Date('2023-01-21').getTime(); // A known new moon date
            const lunarCycle = 29.53 * 24 * 60 * 60 * 1000; // Lunar cycle in milliseconds
            
            const daysSinceNewMoon = (Date.now() - knownNewMoon) % lunarCycle;
            const moonAge = Math.floor(daysSinceNewMoon / (lunarCycle / 28));
            
            // Return appropriate moon phase emoji
            if (moonAge < 1) return '🌑'; // New moon
            if (moonAge < 7) return '🌒'; // Waxing crescent
            if (moonAge < 8) return '🌓'; // First quarter
            if (moonAge < 14) return '🌔'; // Waxing gibbous
            if (moonAge < 15) return '🌕'; // Full moon
            if (moonAge < 21) return '🌖'; // Waning gibbous
            if (moonAge < 22) return '🌗'; // Last quarter
            return '🌘'; // Waning crescent
        }

        // Update local time display
        function updateLocalTime(timezoneOffset) {
            // Clear any existing interval
            clearLocalTimeInterval();
            
            // Update time immediately
            updateTimeDisplay(timezoneOffset);
            
            // Set up interval to update time every second
            localTimeInterval = setInterval(() => {
                updateTimeDisplay(timezoneOffset);
            }, 1000);
        }
        
        function updateTimeDisplay(timezoneOffset) {
            // Convert timezone offset from seconds to minutes
            const offsetMinutes = timezoneOffset / 60;
            
            // Create date with timezone offset
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const localTime = new Date(utc + (offsetMinutes * 60000));
            
            // Format time
            const timeStr = localTime.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Update time display
            localTimeEl.textContent = timeStr;
            
            // Update time icon based on time of day
            const hours = localTime.getHours();
            if (hours >= 6 && hours < 18) {
                timeIconEl.textContent = '☀️';
            } else {
                timeIconEl.textContent = '🌙';
            }
        }
        
        function clearLocalTimeInterval() {
            if (localTimeInterval) {
                clearInterval(localTimeInterval);
                localTimeInterval = null;
            }
        }

        // Get flag emoji from country code
        function getFlagEmoji(countryCode) {
            if (!countryCode) return '';
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        // Add weather animation to panel
        function addWeatherAnimation(type) {
            weatherAnimationEl.innerHTML = '';
            
            if (type === 'sun') {
                weatherAnimationEl.innerHTML = '<div class="sun"></div>';
            } else if (type === 'rain') {
                weatherAnimationEl.innerHTML = `
                    <div class="cloud"></div>
                    <div class="rain-drop"></div>
                    <div class="rain-drop"></div>
                    <div class="rain-drop"></div>
                    <div class="rain-drop"></div>
                `;
            } else if (type === 'storm') {
                weatherAnimationEl.innerHTML = `
                    <div class="cloud"></div>
                    <div class="lightning"></div>
                `;
            } else if (type === 'wind') {
                weatherAnimationEl.innerHTML = `
                    <div class="cloud" style="animation-duration: 8s;"></div>
                `;
            } else if (type === 'snow') {
                weatherAnimationEl.innerHTML = `
                    <div class="cloud"></div>
                    <div class="snowflake"></div>
                    <div class="snowflake"></div>
                    <div class="snowflake"></div>
                    <div class="snowflake"></div>
                `;
            } else if (type === 'night') {
                // Create moon with phase
                const moonPhase = getMoonPhaseEmoji();
                weatherAnimationEl.innerHTML = `
                    <div class="moon"></div>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px;">
                        ${moonPhase}
                    </div>
                `;
            } else {
                // Default clouds
                weatherAnimationEl.innerHTML = '<div class="cloud"></div>';
            }
        }

        // Add animation to map
        function addMapAnimation(latlng, type) {
            if (animMarker) {
                map.removeLayer(animMarker);
                animMarker = null;
            }
            
            const html = buildAnimHTML(type);
            const icon = L.divIcon({
                html,
                className: '',
                iconSize: [0, 0]
            });
            
            animMarker = L.marker(latlng, { icon, interactive: false }).addTo(map);
        }

        // Build animation HTML for map
        function buildAnimHTML(type) {
            if (type === 'sun') {
                return `<div class="weather-anim"><div class="anim-sun"></div></div>`;
            }
            
            if (type === 'rain') {
                return `<div class="weather-anim">
                    <div class="cloud"></div>
                    <div class="drop"></div><div class="drop"></div><div class="drop"></div><div class="drop"></div>
                </div>`;
            }
            
            if (type === 'storm') {
                return `<div class="weather-anim">
                    <div class="cloud" style="animation-duration:8s;"></div>
                    <div class="bolt"></div>
                </div>`;
            }
            
            if (type === 'wind') {
                return `<div class="weather-anim">
                    <div class="wind-line"></div>
                    <div class="wind-line"></div>
                    <div class="wind-line"></div>
                </div>`;
            }
            
            if (type === 'snow') {
                return `<div class="weather-anim">
                    <div class="cloud"></div>
                    <div class="snowflake"></div>
                    <div class="snowflake"></div>
                    <div class="snowflake"></div>
                    <div class="snowflake"></div>
                    <div class="snowflake"></div>
                    <div class="snowflake"></div>
                </div>`;
            }
            
            if (type === 'night') {
                const moonPhase = getMoonPhaseEmoji();
                return `<div class="weather-anim" style="font-size: 24px;">${moonPhase}</div>`;
            }
            
            // Default clouds
            return `<div class="weather-anim"><div class="cloud"></div></div>`;
        }

        // Update forecast
        async function updateForecast(lat, lon) {
            if (!WEATHER_API_KEY) return;
            
            try {
                const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric`;
                const res = await fetch(url);
                
                if (!res.ok) throw new Error(`OpenWeather forecast error ${res.status}`);
                
                const data = await res.json();
                debugLog('Forecast data received');
                
                // Process forecast data - group by day and get daily values
                const dailyForecast = {};
                data.list.forEach(item => {
                    const date = new Date(item.dt * 1000);
                    const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                    
                    if (!dailyForecast[day]) {
                        dailyForecast[day] = {
                            temp: item.main.temp,
                            icon: item.weather[0].main,
                            count: 1
                        };
                    } else {
                        dailyForecast[day].temp = (dailyForecast[day].temp * dailyForecast[day].count + item.main.temp) / (dailyForecast[day].count + 1);
                        dailyForecast[day].count++;
                    }
                });
                
                // Display forecast (next 5 days)
                forecastEl.innerHTML = '';
                const days = Object.keys(dailyForecast).slice(0, 5);
                
                days.forEach(day => {
                    const forecast = dailyForecast[day];
                    const forecastCard = document.createElement('div');
                    forecastCard.className = 'forecast-card';
                    
                    forecastCard.innerHTML = `
                        <div class="forecast-day">${day}</div>
                        <div class="forecast-icon">${getWeatherIcon(forecast.icon)}</div>
                        <div class="forecast-temp">${Math.round(forecast.temp)}°C</div>
                    `;
                    
                    forecastEl.appendChild(forecastCard);
                });
            } catch (err) {
                console.error(err);
                debugLog('Forecast fetch failed: ' + err.message);
            }
        }

        // Get weather icon based on condition
        function getWeatherIcon(condition) {
            condition = condition.toLowerCase();
            
            if (condition.includes('thunder')) return '⛈';
            if (condition.includes('rain')) return '🌧';
            if (condition.includes('snow')) return '❄';
            if (condition.includes('cloud')) return '☁';
            if (condition.includes('clear')) return '☀';
            if (condition.includes('mist') || condition.includes('fog')) return '🌫';
            return '🌤';
        }

        // Fetch city facts from Wikipedia
        async function fetchFacts(city) {
            try {
                factsEl.innerHTML = "<span class='loader'></span> Loading facts...";
                
                const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(city)}`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                
                if (!res.ok) throw new Error(`Wikipedia error ${res.status}`);
                
                const data = await res.json();
                const extract = data.extract || "No summary found.";
                factsEl.innerHTML = `<p>${extract}</p>`;
                
                debugLog('City facts loaded');
            } catch (err) {
                console.error(err);
                factsEl.innerHTML = `<p>Couldn't load facts right now. Please try again later.</p>`;
                debugLog('Facts fetch failed: ' + err.message);
            }
        }

        // Clear city layers
        function clearCityLayers() {
            if (cityLayer) {
                map.removeLayer(cityLayer);
                cityLayer = null;
            }
            
            if (animMarker) {
                map.removeLayer(animMarker);
                animMarker = null;
            }
        }

        // Initialize with a popular city
        setTimeout(() => {
            // Create a mock London place object for initialization
            const londonPlace = {
                display_name: "London, UK",
                lat: "51.5074",
                lon: "-0.1278",
                address: {
                    country_code: "gb"
                }
            };
            selectPlace(londonPlace);
        }, 1000);

        // Add some sample forecast data for initial display
        function addSampleForecast() {
            forecastEl.innerHTML = `
                <div class="forecast-card">
                    <div class="forecast-day">Mon</div>
                    <div class="forecast-icon">☀</div>
                    <div class="forecast-temp">24°C</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-day">Tue</div>
                    <div class="forecast-icon">☁</div>
                    <div class="forecast-temp">22°C</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-day">Wed</div>
                    <div class="forecast-icon">🌧</div>
                    <div class="forecast-temp">19°C</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-day">Thu</div>
                    <div class="forecast-icon">⛈</div>
                    <div class="forecast-temp">17°C</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-day">Fri</div>
                    <div class="forecast-icon">☀</div>
                    <div class="forecast-temp">23°C</div>
                </div>
            `;
        }

        // Initial setup
        addSampleForecast();
        debugLog('Weather Map initialized');
    </script>
</body>
</html>
